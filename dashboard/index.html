<!DOCTYPE html>
<meta name="robots" content="noindex">
<html lang="en">
<head>
  <link rel="apple-touch-icon" sizes="180x180" href="/Images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/Images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/Images/favicon-16x16.png">
  <link rel="manifest" href="/Images/manifest.json">
  <link rel="mask-icon" href="/Images/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ff000">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="utf-8">
  <title>Cloud Thermostat</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="https://use.fontawesome.com/6d70bf0162.js"></script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-103834049-1', 'auto');
  ga('send', 'pageview');

</script>
</head>
<style>
  .graph-cont {
    height: 400px;
    width: 100%;
  }

  h4 {
    margin-top: 1em;
  }

  footer {
    margin: 20px 0;
  }

  .content img {
    margin: 2em 0;
  }
  
ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #333;
}

li {
    float: left;
}

li a {
    display: block;
    color: white;
    text-align: center;
    padding: 12px 16px;
    text-decoration: none;
}

li a:hover {
    background-color: #111;
	    text-decoration: none;
		    color: white;
}

  li a.active {
	  background-color: #111;
		 text-decoration: none;
			color: white; 
  }
  
  li a:focus {
	  text-decoration: none;
		  color:white;
  }

  .container-fluid {
	  padding: 0em 2em;
  }

  .range-btns-cont  {
    display: block;
    float:right;
    visibility: hidden;
    margin: 6px 6px;
  }
</style>
<body>
	
		      <ul>
			  <li><a href="/">Project Summary</a></li>
			  <li><a class="active" href="/dashboard">Dashboard</a></li>
			  <li style="float:right; font-size:16px;"><a href="mailto:connor.benton@gmail.com" style ="padding:14px 14px" class="fa fa-envelope"></a></li>
			  <li style="float:right; font-size:16px;"><a href="https://www.github.com/connorbenton" style = "padding: 14px 14px" class="fa fa-github"></a></li>
		      </ul>
	<div class = "container-fluid">
		<div class="row"> 
	      <div class="col-md-12"> 
        <h3 style="margin: 16px 30px;">Temperature & Thermostat</h3>
      </div>
      </div>

    <div class="row">
	    <div class="col-md-12" style="margin: 0 5% 0 1%; padding: 0">	    

      <div id="graph-cont-1" class="graph-cont">
      </div>
      <div>

        <span id="range-btns-cont-1" class="btn-group range-btns-cont" style="margin: 6px 0 6px 0;">
            <button name="range-btn-5y" class="btn btn-default btn-mini">
              5y
            </button>
            <button name="range-btn-1y" class="btn btn-default btn-mini">
              1y
            </button>
            <button name="range-btn-ytd" class="btn btn-default  btn-mini">
              YTD
            </button>
            <button name="range-btn-6m" class="btn btn-default btn-mini">
              6m
            </button>
            <button name="range-btn-1m" class="btn btn-default  btn-mini">
              1m
            </button>
            <button name="range-btn-1w" class="btn btn-default  btn-mini">
              1w
            </button>
            <button name="range-btn-1d" class="btn btn-default btn-mini">
              1d
            </button>

        </span>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-6">
        <h5>Thermostat Control</h5>

  <div style="padding:0 0 1em 0" id="btn-group-thermostat" class="btn-group" data-toggle="buttons">
      <label style="width:40px" class="btn btn-default" id="off" disabled>
        <!-- <input type="radio" name="off" id="off"> off --> 
	<input type="radio"> off
      </label>
      <label style="width:70px" class="btn btn-default" id="auto" disabled>
        <!-- <input type="radio" name="auto" id="auto"> auto --> 
	<input type="radio"> auto
      </label>
      <label style="width:40px" class="btn btn-default" id="on" disabled>
        <!-- <input type="radio" name="on" id="on"> on --> 
	<input type="radio"> on
      </label>
  </div>
  </div>
    <div class="col-xs-6">
        <h5>Thermostat Setpoint</h5>

  <div style="padding:0 0 1em 0" id="setpoint-group-thermostat" class="btn-group" data-toggle="buttons">
    <button style="width:60px" class="btn btn-default" type="submit" id="down" disabled>down</button>
    <button style="width:40px" class="btn btn-default" type="submit" id="setpoint" disabled>69</button>
    <button style="width:60px" class="btn btn-default" type="submit" id="up" disabled>up</button>
  </div>
    </div>
    </div>

  <div class="row">
    <div class="col-md-12">
<form id="signin" class="form-signin" role="form" style="max-width:300px" hidden>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
                            <input id="username" type="username" class="form-control" name="username" value="" placeholder="Username">                                        
                        </div>

                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
                            <input id="password" type="password" class="form-control" name="password" value="" placeholder="Password">                                        
                        </div>

                        <button type="submit" class="btn btn-default">Login</button>
                   </form>

<form id="form-password" class="form-signin" style="max-width:300px" hidden>
			<span>Set a new password to continue</span>
			<label for="inputNewPassword" class="sr-only">Password</label>
			<input type="password" id="inputNewPassword" class="form-control" placeholder="New Password" required>
			<button class="btn btn-default" type="submit">Change Password</button>
		</form>

		<form id='logged-in' class='form-signout' role="form" hidden>
			<button class="btn btn-default" type="submit">Sign Out</button>
			<span style="color:green; padding:0 10px">Logged in</span>
			<span id="active-user"></span>
		</form>

    </div>
  </div>        
	</div>

 <footer class="footer">
  <div class="container-fluid">
	  <span class="text-muted">&copy; 2017 Connor Benton</span>
  </div>
</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.16.0/moment.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script> -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <!-- <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.5.min.js"></script> -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script src="/scripts/temp_hist.js"></script>
  <script src="/scripts/temp_hist_provider.js"></script>
  <script src="/scripts/temp_hist_server.js"></script>
  <script src="/scripts/thermostat_button.js"></script>
  <script src="/scripts/aws-cognito-sdk.min.js"></script>
  <script src="/scripts/amazon-cognito-identity.min.js"></script>
  <script src="/scripts/aws-sdk-2.171.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.1/dygraph-combined.js"></script> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
<script>
AWS.config.region = 'us-east-1'; // Region
<!-- AWS.config.credentials = new AWS.CognitoIdentityCredentials({ -->
<!--   IdentityPoolId: 'us-east-1:8ad5bccf-36bf-4e06-8c4a-de15f73ceab6' -->
<!--   // region: 'us-east-1' -->
<!-- }); -->
// AWS.config.credentials = new AWS.Credentials(accessKeyId, secreteAccessKey, sessionToken);
// AWS.config.region = 'us-west-1'; // Region
var dynamodb;
const awsIot;
var cognitoUser;
    var poolData = { 
	        UserPoolId : 'us-east-1_RJQUiedeu', // your user pool id here
      		ClientId : 'r9rn0da6vi442upopdvi409l2' // your client id here
    };

var userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool(poolData);

	var pageCfg = {
      $graphCont: $("#graph-cont-1"),
      $rangeBtnsCont: $("#range-btns-cont-1")
    };
	  
    var pageCfg2 = {
      $rangeBtnsCont: $("#btn-group-thermostat")
    };

function refreshCredentials(){
   	cognitoUser = userPool.getCurrentUser();
var validsession = false;
    if (cognitoUser != null) {
        cognitoUser.getSession(function(err, session) {
            if (err) {
                alert(err);
                return;
            }
	validsession = true;
            console.log('session validity: ' + session.isValid());

            // NOTE: getSession must be called to authenticate user before calling getUserAttributes
            cognitoUser.getUserAttributes(function(err, attributes) {
                if (err) {
                    // Handle error
  		     console.log(JSON.stringify(err, null, 3));
                } else {
                    // Do something with attributes
                }
            });

            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
		IdentityPoolId: 'us-east-1:8ad5bccf-36bf-4e06-8c4a-de15f73ceab6',
	        Logins : {
	             'cognito-idp.us-east-1.amazonaws.com/us-east-1_RJQUiedeu' : session.getIdToken().getJwtToken()
	                }
            });
            // Instantiate aws sdk service objects now that the credentials have been updated.
		  dynamodb = new AWS.DynamoDB({region: 'us-west-1'});
	});
	<!-- AWS.config.credentials.refresh((error) => { -->
	<!-- 	if (error) { -->
	<!-- 		console.error(error); -->
	<!-- 	} else { -->
	<!-- 		console.log('AWS credentials refreshed'); -->
	<!-- 	} -->
	<!-- }); -->
	if (validsession) {
	return true;		
	}
    }
}

// var dynamodb = dyanmo.DocumentClient();
  $(document).ready(function () {
	 <!-- var dynamodb; --> 
	document.addEventListener('visibilitychange', function () {
		if (document.visibilityState == 'hidden'){
		} else {
	  if (refreshCredentials()) { 
		  var thist = new temp_hist(pageCfg);
			$("#range-btns-cont-1").children().removeClass('active');	
		  thist.init();
	       	var thermo = new thermostat_button(pageCfg2);
			$("#btn-group-thermostat").children().removeClass('active');	
	  	thermo.init();
	  }
		}
	}, false);
	  
	  if (refreshCredentials()) { 
		  

	            $('#logged-in').removeAttr('hidden');
			document.getElementById('active-user').innerHTML = cognitoUser.username;
	  var thist = new temp_hist(pageCfg);
		$("#range-btns-cont-1").children().removeClass('active');			
	  thist.init();
	  var thermo = new thermostat_button(pageCfg2);
		$("#btn-group-thermostat").children().removeClass('active');			
	  thermo.init();
				<!-- $('#signin').attr('hidden','true'); -->
    } else {
	    $('#signin').removeAttr('hidden');
	  var thist = new temp_hist(pageCfg);
		$("#range-btns-cont-1").children().removeClass('active');			
	  thist.init();
	  var thermo = new thermostat_button(pageCfg2);
		$("#btn-group-thermostat").children().removeClass('active');			
	  thermo.init();
    }
	  
		  $('.form-signout').on('submit',function(e) {
			  e.preventDefault();
			  if (cognitoUser != null) {
			  cognitoUser.signOut();
			  location.reload();
			  }
			});

$('.form-signin').on('submit',function(e) {
		    	e.preventDefault();
		    	var authenticationData = {
			        Username : $('#username').val(),
			        Password : $('#password').val()
			    };
			    var authenticationDetails = new AWSCognito.CognitoIdentityServiceProvider.AuthenticationDetails(authenticationData);
			    var userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool(poolData);
			    var userData = {
			        Username : $('#username').val(),
			        Pool : userPool
			    };
			    
			   cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser(userData);
			    cognitoUser.authenticateUser(authenticationDetails, {
			    	newPasswordRequired: function(userAttributes, requiredAttributes) {
			            $('#form-password').removeAttr('hidden');
			            $('#signin').css('display','none');
			            if ($('#inputNewPassword').val() !== '') {
			            	cognitoUser.completeNewPasswordChallenge($('#inputNewPassword').val(), [], this);
			            }
			        },
			        onSuccess: function (result) {
			            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
			                IdentityPoolId : 'us-east-1:8ad5bccf-36bf-4e06-8c4a-de15f73ceab6',
			                Logins : {
			                    'cognito-idp.us-east-1.amazonaws.com/us-east-1_RJQUiedeu' : result.getIdToken().getJwtToken()
			                }
			            });
			            AWS.config.update({
							region: 'us-east-1',
							credentials: new AWS.CognitoIdentityCredentials({
								IdentityPoolId: 'us-east-1:8ad5bccf-36bf-4e06-8c4a-de15f73ceab6',
				                Logins : {
				                    'cognito-idp.us-east-1.amazonaws.com/us-east-1_RJQUiedeu' : result.getIdToken().getJwtToken()
				                }
							})
						});

				$('#signin').attr('hidden','true');
			            $('#logged-in').removeAttr('hidden');
				document.getElementById('active-user').innerHTML = cognitoUser.username;
					<!-- location.reload; -->
	  var thist = new temp_hist(pageCfg);
		$("#range-btns-cont-1").children().removeClass('active');			
	  thist.init();
	  var thermo = new thermostat_button(pageCfg2);
		$("#btn-group-thermostat").children().removeClass('active');			
	  thermo.init();

			        },
			        onFailure: function(err) {
					if (err.message.includes("Password reset required")) {
						cognitoUser.forgotPassword({
        onSuccess: function (result) {
            console.log('call result: ' + result);
        },
        onFailure: function(err) {
            alert(err);
        },
        inputVerificationCode() {
            var verificationCode = prompt("Please input verification code", "");
            var newPassword = prompt("Enter new password", "");
            cognitoUser.confirmPassword(verificationCode, newPassword, this);
        }
    });
					}
					else {
			            		alert(err);
					}
			        }
			    });
		    });
  });

</script>

<!-- <script type ="text/javascript"></script> -->

</body>
</html>
